"use strict";(self.webpackChunkmg_af_docusaurus=self.webpackChunkmg_af_docusaurus||[]).push([[554],{3905:function(e,t,a){a.d(t,{Zo:function(){return p},kt:function(){return m}});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function s(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?s(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),d=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},p=function(e){var t=d(e.components);return n.createElement(l.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,s=e.originalType,l=e.parentName,p=i(e,["components","mdxType","originalType","parentName"]),c=d(a),m=r,f=c["".concat(l,".").concat(m)]||c[m]||u[m]||s;return a?n.createElement(f,o(o({ref:t},p),{},{components:a})):n.createElement(f,o({ref:t},p))}));function m(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var s=a.length,o=new Array(s);o[0]=c;var i={};for(var l in t)hasOwnProperty.call(t,l)&&(i[l]=t[l]);i.originalType=e,i.mdxType="string"==typeof e?e:r,o[1]=i;for(var d=2;d<s;d++)o[d]=a[d];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},5422:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return i},contentTitle:function(){return l},metadata:function(){return d},toc:function(){return p},default:function(){return c}});var n=a(7462),r=a(3366),s=(a(7294),a(3905)),o=["components"],i={sidebar_position:6},l="DAG testing",d={unversionedId:"mg-airflow/testing",id:"mg-airflow/testing",isDocsHomePage:!1,title:"DAG testing",description:"Our team set a goal to achieve convenient testing of datasets in pipelines.",source:"@site/docs/mg-airflow/testing.md",sourceDirName:"mg-airflow",slug:"/mg-airflow/testing",permalink:"/metadata-governance/docs/mg-airflow/testing",editUrl:"https://github.com/TinkoffCreditSystems/metadata-governance/edit/master/tools/doc-site/docs/mg-airflow/testing.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6},sidebar:"tutorialSidebar",previous:{title:"Running the dev environment using docker-compose",permalink:"/metadata-governance/docs/mg-airflow/development"},next:{title:"Production",permalink:"/metadata-governance/docs/mg-airflow/production"}},p=[{value:"Notes",id:"notes",children:[],level:3}],u={toc:p};function c(e){var t=e.components,a=(0,r.Z)(e,o);return(0,s.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"dag-testing"},"DAG testing"),(0,s.kt)("p",null,"Our team set a goal to achieve convenient testing of datasets in pipelines."),(0,s.kt)("p",null,"To achieve the goal , it is necessary"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"save datasets in a readable format"),(0,s.kt)("li",{parentName:"ul"},"regenerate datasets"),(0,s.kt)("li",{parentName:"ul"},"configure test environments, prepare input data")),(0,s.kt)("p",null,"We have developed a solution that saves datasets in the form of JSON.\n",(0,s.kt)("inlineCode",{parentName:"p"},"pandas.DataFrame.to_json")," allows saving json to a file in a readable form.\nEach json element is saved in a new line. When modifying DAGs, the developer regenerates json, and git shows readable diff. This allows the developer to evaluate changes by the task."),(0,s.kt)("p",null,"DAGs in mg-airflow consist of operators. Operators take input data from external sources or works.\nThe TBaseOperator defines the read_result method for reading the final dataset. Usually the operator saves the data in work.\nPgSCD1 modifies the data in the target table. For testing, data is needed from the target, and not from the temporary table in pg-work,\nso the read_result method is redefined in PgSCD1."),(0,s.kt)("p",null,"It is important to prepare an external environment as similar as possible to a grocery one. docker-compose allows you to organize such an environment.\nIt is possible to initialize databases and raise a web server that will respond in a similar way and use mockups from pytest-mock."),(0,s.kt)("p",null,"Let's take a closer look at the example of a dummy DAG:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-python"},"dag_name = 'dummy'\ndag = generate_dag(dag_dir=f'{settings.DAGS_FOLDER}/dags/{dag_name}')\ndataset = JSONPandasDataset(f'{settings.AIRFLOW_HOME}/tests_data/dags/{dag_name}')\n\ngen_dataset = is_gen_dataset_mode()\n\n@pytest.mark.skipif(condition=gen_dataset, reason='Gen dataset')\n@pytest.mark.parametrize(\n    'task', dag.tasks\n)\ndef test_task(task, mocker, setup_tables):\n    run_and_assert_task(task=task, dataset=dataset, mocker=mocker)\n\n\n@pytest.mark.skipif(condition=(not gen_dataset), reason='Gen dataset')\n@pytest.mark.parametrize(\n    'task', dag.tasks\n)\ndef test_gen_tests_data(task, mocker, setup_tables):\n    run_and_gen_ds(task, f'{settings.AIRFLOW_HOME}/tests_data/dags/{dag_name}')\n")),(0,s.kt)("p",null,"JSONPandasDataset is a class that creates a dictionary of the type ",(0,s.kt)("inlineCode",{parentName:"p"},"dict[task_name, DataFrame]"),".\nWhen calling ",(0,s.kt)("inlineCode",{parentName:"p"},"dataset[task_name]"),", a json file is read, which is converted to a DataFrame."),(0,s.kt)("p",null,"Writing to JSONPandasDataset then proceeds as follows. The dataset key is assigned a DataFrame.\nThen the DataFrame is converted to json and saved to a file called task in json and md formats.\nThe comparison takes place using json and the markdown format allows to see the diff for even small changes."),(0,s.kt)("p",null,"Then the data is tested using py test.\nIf there is a non-empty value for the GEN_DATASET variable in the environment variables, the test data generation mode is started.\nIf GEN_DATASET is empty, then testing is started in the test_task function.\nThe value of the GEN_DATASET environment variable is defined in the is_gen_dataset_mode function.\nDepending on its value, the decorator ",(0,s.kt)("inlineCode",{parentName:"p"},"@pytest.mark.skip if")," mutually excludes the mode of testing and creating reference data."),(0,s.kt)("p",null,"Thus,"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"go into the container and run the bash command shell ",(0,s.kt)("inlineCode",{parentName:"li"},"docker-compose exec app bash")),(0,s.kt)("li",{parentName:"ul"},"enable test data generation mode ",(0,s.kt)("inlineCode",{parentName:"li"},"export GEN_DATASET=any")),(0,s.kt)("li",{parentName:"ul"},"run pytest ",(0,s.kt)("inlineCode",{parentName:"li"},"pytest tests/dags/test_dummy.py")," - test data for dataset will be recreated"),(0,s.kt)("li",{parentName:"ul"},"turn off the test data generation mode ",(0,s.kt)("inlineCode",{parentName:"li"},"export GEN_DATASET=")),(0,s.kt)("li",{parentName:"ul"},"run pytest ",(0,s.kt)("inlineCode",{parentName:"li"},"pytest tests/dags/test_dummy.py")," again - tests will be run")),(0,s.kt)("p",null,"If PyCharm Professional is used, then the GEN_DATASET value can be registered in the Environment Variables\nin the startup configuration and run testing/generation through the application, not the console."),(0,s.kt)("p",null,(0,s.kt)("inlineCode",{parentName:"p"},"@pytest.mark.parametrize('task', dag.tasks)")," - is a decorator that runs a test for each DAG task."),(0,s.kt)("p",null,"run_and_assert_task starts only one task. Input datasets for the task are inserted into the function.\nNext, a task is launched, transformations are performed, the output dataset is compared with the reference one."),(0,s.kt)("p",null,"run_and_gen_ds saves reference data along the transmitted path."),(0,s.kt)("h3",{id:"notes"},"Notes"),(0,s.kt)("ul",null,(0,s.kt)("li",{parentName:"ul"},"DataFrame and other structures in python can contain binary data.\nBinary data cannot be stored in JSON. In such cases, it is necessary to use decode/encode or abandon JSONPandasDataset."),(0,s.kt)("li",{parentName:"ul"},"run_and_assert_task uses xor (exclusive or) for comparison and allows not to sort the dataset.")))}c.isMDXComponent=!0}}]);